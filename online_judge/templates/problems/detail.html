{% extends 'base.html' %}

{% block title %}{{ problem.title }} - Online Judge{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Problem Details -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">{{ problem.title }}</h4>
                    <span class="badge bg-{% if problem.difficulty == 'easy' %}success{% elif problem.difficulty == 'medium' %}warning{% else %}danger{% endif %} fs-6">
                        {{ problem.get_difficulty_display }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <!-- Problem Info -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> Time Limit: {{ problem.time_limit }}ms
                        </small>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-memory"></i> Memory Limit: {{ problem.memory_limit }}MB
                        </small>
                    </div>
                </div>

                <!-- Problem Description -->
                <div class="mb-4">
                    <h5>Problem Description</h5>
                    <div class="border-start border-3 border-primary ps-3">
                        {{ problem.description|linebreaks }}
                    </div>
                </div>

                <!-- Input Format -->
                <div class="mb-4">
                    <h5>Input Format</h5>
                    <div class="border-start border-3 border-info ps-3">
                        {{ problem.input_format|linebreaks }}
                    </div>
                </div>

                <!-- Output Format -->
                <div class="mb-4">
                    <h5>Output Format</h5>
                    <div class="border-start border-3 border-info ps-3">
                        {{ problem.output_format|linebreaks }}
                    </div>
                </div>

                <!-- Sample Input/Output -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Sample Input</h5>
                        <pre class="bg-light p-3 rounded"><code>{{ problem.sample_input }}</code></pre>
                    </div>
                    <div class="col-md-6">
                        <h5>Sample Output</h5>
                        <pre class="bg-light p-3 rounded"><code>{{ problem.sample_output }}</code></pre>
                    </div>
                </div>

                <!-- Constraints -->
                {% if problem.constraints %}
                <div class="mb-4">
                    <h5>Constraints</h5>
                    <div class="border-start border-3 border-warning ps-3">
                        {{ problem.constraints|linebreaks }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        {% if user.is_authenticated %}
            <!-- Submit Solution -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-code"></i> Submit Solution</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'problems:submit' problem.slug %}">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="{{ submission_form.language.id_for_label }}" class="form-label">Language</label>
                            {{ submission_form.language }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ submission_form.source_code.id_for_label }}" class="form-label">Source Code</label>
                            {{ submission_form.source_code }}
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-paper-plane"></i> Submit Solution
                        </button>
                    </form>
                </div>
            </div>

            <!-- User's Previous Submissions -->
            {% if user_submissions %}
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history"></i> Your Previous Submissions</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for submission in user_submissions %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">
                                            {{ submission.language|upper }} | {{ submission.submitted_at|timesince }} ago
                                        </small>
                                        {% if submission.execution_time %}
                                            <br><small class="text-muted">{{ submission.execution_time }}ms</small>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-{% if submission.verdict == 'AC' %}success{% elif submission.verdict == 'PE' %}warning{% else %}danger{% endif %}">
                                            {{ submission.verdict_display }}
                                        </span>
                                        <br>
                                        <a href="{{ submission.get_absolute_url }}" class="btn btn-sm btn-outline-primary mt-1">
                                            View
                                        </a>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
        {% else %}
            <!-- Login Prompt -->
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-sign-in-alt fa-3x text-muted mb-3"></i>
                    <h5>Login Required</h5>
                    <p class="text-muted">You need to login to submit solutions to this problem.</p>
                    <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </a>
                    <a href="{% url 'accounts:signup' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-user-plus"></i> Sign Up
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize CodeMirror for code editor
document.addEventListener('DOMContentLoaded', function() {
    const codeTextarea = document.querySelector('.code-editor');
    if (codeTextarea) {
        const editor = CodeMirror.fromTextArea(codeTextarea, {
            lineNumbers: true,
            theme: 'monokai',
            indentUnit: 4,
            matchBrackets: true,
            autoCloseBrackets: true,
        });

        // Change mode based on language selection
        const languageSelect = document.querySelector('#id_language');
        const updateMode = () => {
            const language = languageSelect.value;
            let mode = 'text/plain';
            
            switch(language) {
                case 'python':
                    mode = 'python';
                    break;
                case 'cpp':
                case 'c':
                    mode = 'text/x-csrc';
                    break;
                case 'java':
                    mode = 'text/x-java';
                    break;
            }
            
            editor.setOption('mode', mode);
        };

        languageSelect.addEventListener('change', updateMode);
        updateMode(); // Set initial mode
    }
});
</script>
{% endblock %}
