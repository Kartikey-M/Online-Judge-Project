{% extends 'base.html' %}
{% load static %}

{% block title %}{{ problem.title }} - Online Judge{% endblock %}

{% block extra_css %}
<style>
    .problem-header {
        background: #21262d;
        color: #f0f6fc;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        border: 1px solid #30363d;
    }
    
    .problem-section {
        background: #21262d;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        margin-bottom: 1.5rem;
        border-left: 4px solid #007bff;
        color: #f0f6fc;
    }
    
    .section-header {
        background: #161b22;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #30363d;
        border-radius: 10px 10px 0 0;
    }
    
    .section-content {
        padding: 1.5rem;
    }
    
    .problem-description {
        color: #f0f6fc !important;
        line-height: 1.6;
        font-size: 15px;
    }

    .problem-description p {
        color: #f0f6fc !important;
        margin-bottom: 15px;
    }

    .problem-content {
        color: #f0f6fc !important;
    }
    
    .sample-box {
        background: #161b22;
        padding: 1rem;
        border-radius: 5px;
        font-family: monospace;
        white-space: pre-wrap;
        margin-bottom: 1rem;
        border: 1px solid #30363d;
        color: #f0f6fc;
    }
    
    .submission-card {
        background: #21262d;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        margin-bottom: 1.5rem;
        border: 1px solid #30363d;
        color: #f0f6fc;
    }
    
    .submission-header {
        background: linear-gradient(135deg, #2ea043 0%, #238636 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 15px 15px 0 0;
    }
    
    .language-selector select {
        background: #161b22;
        color: #f0f6fc;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 0.7rem;
        width: 100%;
    }
    
    .code-editor-container {
        position: relative;
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .CodeMirror {
        height: 400px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
    }
    
    .submit-btn {
        background: linear-gradient(135deg, #2ea043 0%, #238636 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 10px;
        font-weight: bold;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(46, 160, 67, 0.3);
    }
    
    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(46, 160, 67, 0.4);
        color: white;
    }
    
    .btn-test {
        background: linear-gradient(135deg, #0969da 0%, #1f6feb 100%);
        color: white;
        border: none;
        padding: 0.7rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-compile {
        background: linear-gradient(135deg, #6f42c1 0%, #8b5cf6 100%);
        color: white;
        border: none;
        padding: 0.7rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .compiler-section {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .compiler-header {
        background: #0d1117;
        padding: 1rem;
        border-bottom: 1px solid #30363d;
        border-radius: 8px 8px 0 0;
    }
    
    .compiler-output {
        padding: 1rem;
        font-family: monospace;
        background: #0d1117;
        color: #f0f6fc;
        min-height: 200px;
        white-space: pre-wrap;
    }
    
    .test-results {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .test-result-item {
        background: #21262d;
        border: 1px solid #30363d;
        border-radius: 8px;
        margin-bottom: 1rem;
        overflow: hidden;
    }
    
    .test-result-header {
        background: #161b22;
        padding: 1rem;
        border-bottom: 1px solid #30363d;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .test-status-pass {
        background: #2ea043;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: bold;
    }
    
    .test-status-fail {
        background: #da3633;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: bold;
    }
    
    .split-container {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .problem-panel {
        flex: 1;
        min-width: 450px;
    }
    
    .code-panel {
        flex: 1.2;
        min-width: 550px;
    }
    
    @media (max-width: 768px) {
        .split-container {
            flex-direction: column;
        }
        
        .problem-panel,
        .code-panel {
            min-width: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Problem Header -->
    <div class="problem-header text-center">
        <h1 class="display-4 mb-3">{{ problem.title }}</h1>
        <div class="d-flex justify-content-center gap-3 mb-3">
            <span class="badge bg-{% if problem.difficulty == 'easy' %}success{% elif problem.difficulty == 'medium' %}warning{% else %}danger{% endif %} fs-6">
                <i class="fas fa-star"></i> {{ problem.get_difficulty_display }}
            </span>
            <span class="badge bg-info fs-6">
                <i class="fas fa-clock"></i> {{ problem.time_limit }}ms
            </span>
            <span class="badge bg-secondary fs-6">
                <i class="fas fa-memory"></i> {{ problem.memory_limit }}MB
            </span>
        </div>
    </div>

    <div class="split-container">
        <!-- Problem Description Panel -->
        <div class="problem-panel">
            <!-- Problem Description -->
            <div class="problem-section">
                <div class="section-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-text"></i> Problem Description
                    </h5>
                </div>
                <div class="section-content">
                    <div class="problem-content">
                        {{ problem.description|linebreaks }}
                    </div>
                </div>
            </div>

            <!-- Input Format -->
            {% if problem.input_format %}
            <div class="problem-section">
                <div class="section-header">
                    <h6 class="mb-0">
                        <i class="fas fa-arrow-right"></i> Input Format
                    </h6>
                </div>
                <div class="section-content">
                    {{ problem.input_format|linebreaks }}
                </div>
            </div>
            {% endif %}

            <!-- Output Format -->
            {% if problem.output_format %}
            <div class="problem-section">
                <div class="section-header">
                    <h6 class="mb-0">
                        <i class="fas fa-arrow-left"></i> Output Format
                    </h6>
                </div>
                <div class="section-content">
                    {{ problem.output_format|linebreaks }}
                </div>
            </div>
            {% endif %}

            <!-- Sample Input/Output -->
            {% if sample_cases %}
            {% for case in sample_cases %}
            <div class="problem-section">
                <div class="section-header">
                    <h6 class="mb-0">
                        <i class="fas fa-play"></i> Sample {{ forloop.counter }}
                    </h6>
                </div>
                <div class="section-content">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Input:</strong>
                            <div class="sample-box">{{ case.input_data }}</div>
                        </div>
                        <div class="col-md-6">
                            <strong>Output:</strong>
                            <div class="sample-box">{{ case.expected_output }}</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>

        <!-- Code Submission Panel -->
        <div class="code-panel">
            <div class="submission-card">
                <div class="submission-header text-center">
                    <h4 class="mb-2">
                        <i class="fas fa-code"></i> Submit Your Solution
                    </h4>
                    <p class="mb-0">Choose your language and code away!</p>
                </div>
                
                <div class="card-body p-3">
                    <form method="post" action="{% url 'problems:submit' problem.slug %}" id="submission-form">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="{{ submission_form.language.id_for_label }}" class="form-label">
                                <i class="fas fa-code-branch"></i> Programming Language
                            </label>
                            <div class="language-selector">
                                {{ submission_form.language }}
                            </div>
                            <small class="form-text text-muted">Choose the language you want to code in</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ submission_form.source_code.id_for_label }}" class="form-label">
                                <i class="fas fa-file-code"></i> Source Code
                            </label>
                            <div class="code-editor-container">
                                {{ submission_form.source_code }}
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="submit-btn" id="submit-btn">
                                <i class="fas fa-paper-plane"></i> Submit Solution
                            </button>
                            
                            <div class="row">
                                <div class="col-6">
                                    <button type="button" class="btn-test w-100" id="test-btn">
                                        <i class="fas fa-vial"></i> Test Samples
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button type="button" class="btn-compile w-100" id="compile-btn">
                                        <i class="fas fa-play"></i> Online Compiler
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Online Compiler Section -->
            <div class="compiler-section" id="compiler-section" style="display: none;">
                <div class="compiler-header">
                    <h6 class="mb-2">
                        <i class="fas fa-terminal"></i> Online Compiler
                    </h6>
                    <div class="mb-3">
                        <label for="compiler-input" class="form-label">Input (Optional):</label>
                        <textarea id="compiler-input" class="form-control" rows="3" 
                                  style="background: #0d1117; color: #f0f6fc; border: 1px solid #30363d;"
                                  placeholder="Enter input for your program..."></textarea>
                    </div>
                </div>
                <div class="compiler-output" id="compiler-output">
                    Click "Online Compiler" to run your code...
                </div>
                <div class="p-2 border-top" style="border-color: #30363d !important;">
                    <small id="compiler-info" class="text-muted">Ready to compile</small>
                </div>
            </div>

            <!-- Test Results Section -->
            <div class="test-results" id="test-results-section" style="display: none;">
                <div class="compiler-header">
                    <h6 class="mb-0">
                        <i class="fas fa-list-check"></i> Test Results
                    </h6>
                </div>
                <div class="p-3" id="test-results">
                    Click "Test Samples" to run against sample test cases...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let editor;

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing CodeMirror...');
    
    const codeTextarea = document.querySelector('#id_source_code');
    console.log('Code textarea found:', codeTextarea);
    
    if (codeTextarea) {
        // Initialize CodeMirror
        editor = CodeMirror.fromTextArea(codeTextarea, {
            lineNumbers: true,
            theme: 'monokai',
            indentUnit: 4,
            matchBrackets: true,
            autoCloseBrackets: true,
            lineWrapping: true,
            mode: 'python',
        });
        
        console.log('CodeMirror editor initialized:', editor);

        const languageSelect = document.querySelector('#id_language');
        
        // Set initial mode based on language
        if (languageSelect) {
            const updateEditorMode = () => {
                const language = languageSelect.value;
                const templates = {
                    'python': {
                        mode: 'python',
                        template: `# Write your Python code here
def main():
    # Your solution
    pass

if __name__ == "__main__":
    main()`
                    },
                    'cpp': {
                        mode: 'text/x-c++src',
                        template: `#include <iostream>
using namespace std;

int main() {
    // Write your C++ code here
    
    return 0;
}`
                    },
                    'java': {
                        mode: 'text/x-java',
                        template: `public class Solution {
    public static void main(String[] args) {
        // Write your Java code here
        
    }
}`
                    },
                    'javascript': {
                        mode: 'javascript',
                        template: `// Write your JavaScript code here
function main() {
    // Your solution
    
}

main();`
                    }
                };
                
                const config = templates[language] || templates['python'];
                editor.setOption('mode', config.mode);
                
                // Set template if editor is empty
                if (editor.getValue().trim() === '' || editor.getValue().includes('Your code will appear here')) {
                    editor.setValue(config.template);
                }
            };
            
            languageSelect.addEventListener('change', updateEditorMode);
            updateEditorMode(); // Set initial template
        }
        
        editor.focus();
    }

    // Form submission handling
    const form = document.getElementById('submission-form');
    const submitBtn = document.getElementById('submit-btn');
    
    console.log('Form:', form);
    console.log('Submit button:', submitBtn);
    
    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            console.log('Form submission triggered');
            
            // Update textarea with CodeMirror content before submission
            if (editor) {
                console.log('Saving editor content');
                editor.save();
                
                // Double-check that the content was saved
                const sourceCode = editor.getValue().trim();
                const textarea = document.querySelector('#id_source_code');
                if (textarea) {
                    textarea.value = sourceCode;
                    console.log('Source code length:', sourceCode.length);
                }
            }
            
            // Validate code
            const sourceCode = editor ? editor.getValue().trim() : '';
            console.log('Validating source code:', sourceCode.length, 'characters');
            
            if (!sourceCode || sourceCode.length < 10) {
                e.preventDefault();
                alert('Please write some code before submitting!');
                return false;
            }
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            console.log('Form submission allowed');
            // Allow form to submit normally
            return true;
        });
    } else {
        console.error('Form or submit button not found!');
    }

    // Test against samples
    const testBtn = document.getElementById('test-btn');
    if (testBtn) {
        testBtn.addEventListener('click', function() {
            if (!editor) return;
            
            const language = document.querySelector('#id_language').value;
            const sourceCode = editor.getValue().trim();
            
            if (!sourceCode || sourceCode.length < 10) {
                alert('Please write some code before testing!');
                return;
            }
            
            // Hide compiler output when testing
            const compilerSection = document.getElementById('compiler-section');
            if (compilerSection) {
                compilerSection.style.display = 'none';
            }
            
            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            
            fetch(`{% url 'judge:test_samples' problem.slug %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    language: language,
                    source_code: sourceCode
                })
            })
            .then(response => response.json())
            .then(data => {
                displayTestResults(data);
                document.getElementById('test-results-section').style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error running tests: ' + error);
            })
            .finally(() => {
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="fas fa-vial"></i> Test Samples';
            });
        });
    }

    // Online compiler
    const compileBtn = document.getElementById('compile-btn');
    if (compileBtn) {
        compileBtn.addEventListener('click', function() {
            if (!editor) return;
            
            const language = document.querySelector('#id_language').value;
            const sourceCode = editor.getValue().trim();
            const inputData = document.getElementById('compiler-input').value;
            
            if (!sourceCode || sourceCode.length < 10) {
                alert('Please write some code before running!');
                return;
            }
            
            // Hide test results when using compiler
            const testResultsSection = document.getElementById('test-results-section');
            if (testResultsSection) {
                testResultsSection.style.display = 'none';
            }
            
            compileBtn.disabled = true;
            compileBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
            
            fetch(`{% url 'judge:compile_run' %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    language: language,
                    source_code: sourceCode,
                    input_data: inputData
                })
            })
            .then(response => response.json())
            .then(data => {
                displayCompilerResults(data);
                // Show compiler output section
                const compilerSection = document.getElementById('compiler-section');
                if (compilerSection) {
                    compilerSection.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('compiler-output').innerHTML = '<span class="text-danger">Error: ' + error + '</span>';
            })
            .finally(() => {
                compileBtn.disabled = false;
                compileBtn.innerHTML = '<i class="fas fa-play"></i> Online Compiler';
            });
        });
    }
});

function displayTestResults(data) {
    const container = document.getElementById('test-results');
    if (!data.results || data.results.length === 0) {
        container.innerHTML = '<p class="text-muted">No test results available.</p>';
        return;
    }
    
    let html = '';
    data.results.forEach((result, index) => {
        const statusClass = result.passed ? 'test-status-pass' : 'test-status-fail';
        const statusText = result.passed ? 'PASSED' : 'FAILED';
        
        html += `
            <div class="test-result-item">
                <div class="test-result-header">
                    <strong>Test Case ${index + 1}</strong>
                    <span class="${statusClass}">${statusText}</span>
                </div>
                <div class="card-body" style="color: #f0f6fc;">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Input:</strong>
                            <pre class="small mt-1" style="background: #0d1117; padding: 0.5rem; border-radius: 4px;">${result.input || 'N/A'}</pre>
                        </div>
                        <div class="col-md-4">
                            <strong>Expected:</strong>
                            <pre class="small mt-1" style="background: #0d1117; padding: 0.5rem; border-radius: 4px;">${result.expected || 'N/A'}</pre>
                        </div>
                        <div class="col-md-4">
                            <strong>Your Output:</strong>
                            <pre class="small mt-1" style="background: #0d1117; padding: 0.5rem; border-radius: 4px;">${result.output || result.error || 'No output'}</pre>
                        </div>
                    </div>
                    ${result.execution_time ? `<small class="text-muted">Execution time: ${result.execution_time}ms</small>` : ''}
                </div>
            </div>`;
    });
    
    container.innerHTML = html;
}

function displayCompilerResults(data) {
    const outputContainer = document.getElementById('compiler-output');
    const infoContainer = document.getElementById('compiler-info');
    
    if (data.success) {
        outputContainer.innerHTML = `<pre style="margin: 0; white-space: pre-wrap;">${data.output || 'No output'}</pre>`;
        infoContainer.innerHTML = `<i class="fas fa-check text-success"></i> Execution time: ${data.execution_time}ms`;
    } else {
        outputContainer.innerHTML = `<span class="text-danger">${data.error}</span>`;
        infoContainer.innerHTML = `<i class="fas fa-times text-danger"></i> ${data.compilation_error ? 'Compilation failed' : 'Runtime error'}`;
    }
}
</script>
{% endblock %}
