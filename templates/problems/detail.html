{% extends 'base.html' %}
{% load static %}

{% block title %}{{ problem.title }} - Code Matrix{% endblock %}

{% block extra_css %}
<style>
    .problem-header {
        background: #21262d;
        color: #f0f6fc;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        border: 1px solid #30363d;
    }
    
    .problem-section {
        background: #21262d;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        margin-bottom: 1.5rem;
        border-left: 4px solid #007bff;
        color: #f0f6fc;
    }
    
    .section-header {
        background: #161b22;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #30363d;
        border-radius: 10px 10px 0 0;
    }
    
    .section-content {
        padding: 1.5rem;
    }
    
    .problem-description {
        color: #f0f6fc !important;
        line-height: 1.6;
        font-size: 15px;
    }

    .problem-description p {
        color: #f0f6fc !important;
        margin-bottom: 15px;
    }

    .problem-content {
        color: #f0f6fc !important;
    }
    
    .sample-box {
        background: #161b22;
        padding: 1rem;
        border-radius: 5px;
        font-family: monospace;
        white-space: pre-wrap;
        margin-bottom: 1rem;
        border: 1px solid #30363d;
        color: #f0f6fc;
    }
    
    .submission-card {
        background: #21262d;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        margin-bottom: 1.5rem;
        border: 1px solid #30363d;
        color: #f0f6fc;
    }
    
    .submission-header {
        background: linear-gradient(135deg, #2ea043 0%, #238636 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 15px 15px 0 0;
    }
    
    .language-selector select {
        background: #161b22;
        color: #f0f6fc;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 0.7rem;
        width: 100%;
    }
    
    .code-editor-container {
        position: relative;
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .CodeMirror {
        height: 400px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
    }
    
    .submit-btn {
        background: linear-gradient(135deg, #2ea043 0%, #238636 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 10px;
        font-weight: bold;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(46, 160, 67, 0.3);
    }
    
    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(46, 160, 67, 0.4);
        color: white;
    }
    
    .btn-test {
        background: linear-gradient(135deg, #0969da 0%, #1f6feb 100%);
        color: white;
        border: none;
        padding: 0.7rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-compile {
        background: linear-gradient(135deg, #6f42c1 0%, #8b5cf6 100%);
        color: white;
        border: none;
        padding: 0.7rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .compiler-section {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .compiler-header {
        background: #0d1117;
        padding: 1rem;
        border-bottom: 1px solid #30363d;
        border-radius: 8px 8px 0 0;
    }
    
    .compiler-output {
        padding: 1rem;
        font-family: monospace;
        background: #0d1117;
        color: #f0f6fc;
        min-height: 200px;
        white-space: pre-wrap;
    }
    
    .test-results {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .test-result-item {
        background: #21262d;
        border: 1px solid #30363d;
        border-radius: 8px;
        margin-bottom: 1rem;
        overflow: hidden;
    }
    
    .test-result-header {
        background: #161b22;
        padding: 1rem;
        border-bottom: 1px solid #30363d;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .test-status-pass {
        background: #2ea043;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: bold;
    }
    
    .test-status-fail {
        background: #da3633;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: bold;
    }
    
    .split-container {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .problem-panel {
        flex: 1;
        min-width: 450px;
    }
    
    .code-panel {
        flex: 1.2;
        min-width: 550px;
    }
    
    @media (max-width: 768px) {
        .split-container {
            flex-direction: column;
        }
        
        .problem-panel,
        .code-panel {
            min-width: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <!-- Problem Header -->
    <div class="problem-header text-center">
        <h1 class="display-4 mb-3">{{ problem.title }}</h1>
        <div class="d-flex justify-content-center gap-3 mb-3">
            <span class="badge bg-{% if problem.difficulty == 'easy' %}success{% elif problem.difficulty == 'medium' %}warning{% else %}danger{% endif %} fs-6">
                <i class="fas fa-star"></i> {{ problem.get_difficulty_display }}
            </span>
            <span class="badge bg-info fs-6">
                <i class="fas fa-clock"></i> {{ problem.time_limit }}ms
            </span>
            <span class="badge bg-secondary fs-6">
                <i class="fas fa-memory"></i> {{ problem.memory_limit }}MB
            </span>
        </div>
    </div>

    <div class="split-container">
        <!-- Problem Description Panel -->
        <div class="problem-panel">
            <!-- Problem Description -->
            <div class="problem-section">
                <div class="section-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-text"></i> Problem Description
                    </h5>
                </div>
                <div class="section-content">
                    <div class="problem-content">
                        {{ problem.description|linebreaks }}
                    </div>
                </div>
            </div>

            <!-- Input Format -->
            {% if problem.input_format %}
            <div class="problem-section">
                <div class="section-header">
                    <h6 class="mb-0">
                        <i class="fas fa-arrow-right"></i> Input Format
                    </h6>
                </div>
                <div class="section-content">
                    {{ problem.input_format|linebreaks }}
                </div>
            </div>
            {% endif %}

            <!-- Output Format -->
            {% if problem.output_format %}
            <div class="problem-section">
                <div class="section-header">
                    <h6 class="mb-0">
                        <i class="fas fa-arrow-left"></i> Output Format
                    </h6>
                </div>
                <div class="section-content">
                    {{ problem.output_format|linebreaks }}
                </div>
            </div>
            {% endif %}

            <!-- Sample Input/Output -->
            {% if sample_cases %}
            {% for case in sample_cases %}
            <div class="problem-section">
                <div class="section-header">
                    <h6 class="mb-0">
                        <i class="fas fa-play"></i> Sample {{ forloop.counter }}
                    </h6>
                </div>
                <div class="section-content">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Input:</strong>
                            <div class="sample-box">{{ case.input_data }}</div>
                        </div>
                        <div class="col-md-6">
                            <strong>Output:</strong>
                            <div class="sample-box">{{ case.expected_output }}</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}

            <!-- AI Assistant Section -->
            {% if user.is_authenticated %}
            <div class="problem-section">
                <div class="section-header">
                    <h6 class="mb-0">
                        <i class="fas fa-robot"></i> AI Assistant
                    </h6>
                </div>
                <div class="section-content">
                    <p class="text-muted mb-3">
                        <small>Need help? Get an AI-powered hint to guide you toward the solution!</small>
                    </p>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-info" id="get-hint-btn">
                            <i class="fas fa-lightbulb"></i> Get AI Hint
                        </button>
                    </div>
                    <div id="ai-hint-container" style="display: none;" class="mt-3">
                        <div class="alert alert-info border-info" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); border: 2px solid #17a2b8; box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);">
                            <h5 class="mb-3" style="color: white; font-weight: bold;">
                                <i class="fas fa-robot me-2"></i> AI Hint
                            </h5>
                            <div id="ai-hint-content" style="color: white; font-size: 1.1rem; line-height: 1.6; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid #fff;"></div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Code Submission Panel -->
        <div class="code-panel">
            <div class="submission-card">
                <div class="submission-header text-center">
                    <h4 class="mb-2">
                        <i class="fas fa-code"></i> Submit Your Solution
                    </h4>
                    <p class="mb-0">Choose your language and code away!</p>
                </div>
                
                <div class="card-body p-3">
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'problems:submit' problem.slug %}" id="submission-form">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="{{ submission_form.language.id_for_label }}" class="form-label">
                                <i class="fas fa-code-branch"></i> Programming Language
                            </label>
                            <div class="language-selector">
                                {{ submission_form.language }}
                            </div>
                            <small class="form-text text-muted">Choose the language you want to code in</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ submission_form.source_code.id_for_label }}" class="form-label">
                                <i class="fas fa-file-code"></i> Source Code
                            </label>
                            <div class="code-editor-container">
                                {{ submission_form.source_code }}
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="submit-btn" id="submit-btn">
                                <i class="fas fa-paper-plane"></i> Submit Solution
                            </button>
                            
                            <div class="row">
                                <div class="col-6">
                                    <button type="button" class="btn-test w-100" id="test-btn">
                                        <i class="fas fa-vial"></i> Test Samples
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button type="button" class="btn-compile w-100" id="compile-btn">
                                        <i class="fas fa-play"></i> Online Compiler
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-sign-in-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Please Log In to Submit Solutions</h5>
                        <p class="text-muted">You need to be logged in to submit your code and track your progress.</p>
                        <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Log In
                        </a>
                        <a href="{% url 'accounts:signup' %}" class="btn btn-outline-primary ms-2">
                            <i class="fas fa-user-plus"></i> Sign Up
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Online Compiler Section -->
            <div class="compiler-section" id="compiler-section" style="display: none;">
                <div class="compiler-header">
                    <h6 class="mb-2">
                        <i class="fas fa-terminal"></i> Online Compiler
                    </h6>
                    <div class="mb-3">
                        <label for="compiler-input" class="form-label">Input (Optional):</label>
                        <textarea id="compiler-input" class="form-control" rows="3" 
                                  style="background: #0d1117; color: #f0f6fc; border: 1px solid #30363d;"
                                  placeholder="Enter input for your program..."></textarea>
                    </div>
                </div>
                <div class="compiler-output" id="compiler-output">
                    Click "Online Compiler" to run your code...
                </div>
                <div class="p-2 border-top" style="border-color: #30363d !important;">
                    <small id="compiler-info" class="text-muted">Ready to compile</small>
                </div>
            </div>

            <!-- Test Results Section -->
            <div class="test-results" id="test-results-section" style="display: none;">
                <div class="compiler-header">
                    <h6 class="mb-0">
                        <i class="fas fa-list-check"></i> Test Results
                    </h6>
                </div>
                <div class="p-3" id="test-results">
                    Click "Test Samples" to run against sample test cases...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let editor;

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing...');
    
    // Initialize CodeMirror
    const codeTextarea = document.querySelector('#id_source_code');
    console.log('Textarea found:', !!codeTextarea);
    
    if (codeTextarea && typeof CodeMirror !== 'undefined') {
        editor = CodeMirror.fromTextArea(codeTextarea, {
            lineNumbers: true,
            theme: 'monokai',
            indentUnit: 4,
            matchBrackets: true,
            autoCloseBrackets: true,
            lineWrapping: true,
            mode: 'python',
        });
        
        console.log('CodeMirror initialized:', !!editor);

        // Language switching
        const languageSelect = document.querySelector('#id_language');
        if (languageSelect) {
            console.log('Language selector found, current value:', languageSelect.value);
            
            const updateEditorMode = () => {
                const language = languageSelect.value;
                console.log('Language changed to:', language);
                
                const templates = {
                    'python': {
                        mode: 'python',
                        template: `# Write your Python code here
def main():
    # Your solution
    pass

if __name__ == "__main__":
    main()`
                    },
                    'cpp': {
                        mode: 'text/x-c++src',
                        template: `#include <iostream>
using namespace std;

int main() {
    // Write your C++ code here
    
    return 0;
}`
                    },
                    'c': {
                        mode: 'text/x-csrc',
                        template: `#include <stdio.h>

int main() {
    // Write your C code here
    
    return 0;
}`
                    },
                    'java': {
                        mode: 'text/x-java',
                        template: `public class Solution {
    public static void main(String[] args) {
        // Write your Java code here
        
    }
}`
                    }
                };
                
                const config = templates[language] || templates['python'];
                editor.setOption('mode', config.mode);
                
                // Always set template when language changes (not just when empty)
                const currentCode = editor.getValue().trim();
                
                // Check if it's the default template or similar to one
                const isDefaultTemplate = currentCode === '' || 
                                        currentCode.includes('Your code will appear here') ||
                                        currentCode.includes('Write your Python code here') ||
                                        currentCode.includes('Write your C++ code here') ||
                                        currentCode.includes('Write your C code here') ||
                                        currentCode.includes('Write your Java code here') ||
                                        currentCode.includes('def main():') ||
                                        currentCode.includes('#include <iostream>') ||
                                        currentCode.includes('#include <stdio.h>') ||
                                        currentCode.includes('public class Solution') ||
                                        currentCode.length < 50; // Consider short code as template
                
                // For default templates or short code, always replace
                // For longer code, ask for confirmation
                let shouldReplace = isDefaultTemplate;
                if (!isDefaultTemplate && currentCode.length > 50) {
                    shouldReplace = confirm('Replace current code with template for ' + language.toUpperCase() + '?');
                }
                
                if (shouldReplace) {
                    editor.setValue(config.template);
                }
                
                console.log('Language switched to:', language, 'Mode:', config.mode, 'Code replaced:', shouldReplace);
            };
            
            languageSelect.addEventListener('change', updateEditorMode);
            
            // Set initial template based on current selection
            setTimeout(() => {
                updateEditorMode(); // Set initial template with a slight delay
            }, 100);
        }
        
        editor.focus();
    }

    // Form submission handling
    const submitBtn = document.getElementById('submit-btn');
    const form = document.getElementById('submission-form');
    const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};

    if (form && submitBtn && isAuthenticated) {
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault(); // Always prevent default button behavior first

            if (!editor) {
                alert('Code editor not initialized. Please refresh the page.');
                return;
            }
            
            editor.save(); // Ensure the textarea is updated with the editor's content
            const sourceCode = editor.getValue().trim();
            const textarea = document.querySelector('#id_source_code');
            if (textarea) {
                textarea.value = sourceCode;
            }

            // Validation
            if (sourceCode.length < 10) {
                alert('Please write some code before submitting! (minimum 10 characters)');
                return;
            }
            if (sourceCode.includes('Write your') && sourceCode.includes('code here')) {
                alert('Please replace the template with your actual solution!');
                return;
            }

            // Disable the button and show a loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            // Manually submit the form
            form.submit();
        });
    }

    // Test samples button
    const testBtn = document.getElementById('test-btn');
    if (testBtn) {
        testBtn.addEventListener('click', function() {
            if (!editor) {
                alert('Code editor not initialized');
                return;
            }
            
            const language = document.querySelector('#id_language').value;
            const sourceCode = editor.getValue().trim();
            
            if (!sourceCode || sourceCode.length < 10) {
                alert('Please write some code before testing!');
                return;
            }
            
            // Hide compiler section
            const compilerSection = document.getElementById('compiler-section');
            if (compilerSection) {
                compilerSection.style.display = 'none';
            }
            
            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            
            fetch(`{% url 'judge:test_samples' problem.slug %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    language: language,
                    source_code: sourceCode
                })
            })
            .then(response => response.json())
            .then(data => {
                displayTestResults(data);
                document.getElementById('test-results-section').style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error running tests: ' + error);
            })
            .finally(() => {
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="fas fa-vial"></i> Test Samples';
            });
        });
    }

    // Online compiler button
    const compileBtn = document.getElementById('compile-btn');
    if (compileBtn) {
        compileBtn.addEventListener('click', function() {
            if (!editor) {
                alert('Code editor not initialized');
                return;
            }
            
            const language = document.querySelector('#id_language').value;
            const sourceCode = editor.getValue().trim();
            const inputData = document.getElementById('compiler-input').value;
            
            if (!sourceCode || sourceCode.length < 10) {
                alert('Please write some code before running!');
                return;
            }
            
            // Hide test results section
            const testResultsSection = document.getElementById('test-results-section');
            if (testResultsSection) {
                testResultsSection.style.display = 'none';
            }
            
            compileBtn.disabled = true;
            compileBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
            
            fetch(`{% url 'judge:compile_run' %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    language: language,
                    source_code: sourceCode,
                    input_data: inputData
                })
            })
            .then(response => response.json())
            .then(data => {
                displayCompilerResults(data);
                document.getElementById('compiler-section').style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('compiler-output').innerHTML = '<span class="text-danger">Error: ' + error + '</span>';
            })
            .finally(() => {
                compileBtn.disabled = false;
                compileBtn.innerHTML = '<i class="fas fa-play"></i> Online Compiler';
            });
        });
    }

    // AI Hint button
    const getHintBtn = document.getElementById('get-hint-btn');
    
    if (getHintBtn) {
        getHintBtn.addEventListener('click', function() {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                alert('CSRF token not found. Please refresh the page.');
                return;
            }

            // Check if required elements exist
            const hintContent = document.getElementById('ai-hint-content');
            const hintContainer = document.getElementById('ai-hint-container');
            
            if (!hintContent || !hintContainer) {
                alert('AI hint elements not found. Please refresh the page.');
                return;
            }
            
            getHintBtn.disabled = true;
            getHintBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Hint...';
            
            fetch(`{% url 'ai_assistant:problem_hint' problem.id %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken.value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hintContent.innerHTML = data.hint;
                    hintContainer.style.display = 'block';
                    
                    // Ensure the hint stays visible and scroll to it
                    hintContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    getHintBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Get Another Hint';
                } else {
                    alert('Error: ' + (data.error || 'Unable to get hint'));
                    getHintBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Get AI Hint';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error getting hint: ' + error);
                getHintBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Get AI Hint';
            })
            .finally(() => {
                getHintBtn.disabled = false;
            });
        });
    }
});

function displayTestResults(data) {
    const container = document.getElementById('test-results');
    if (!data.results || data.results.length === 0) {
        container.innerHTML = '<p class="text-muted">No test results available.</p>';
        return;
    }
    
    let html = '';
    let hasFailures = false;
    
    data.results.forEach((result, index) => {
        const statusClass = result.passed ? 'test-status-pass' : 'test-status-fail';
        const statusText = result.passed ? 'PASSED' : 'FAILED';
        
        if (!result.passed) {
            hasFailures = true;
        }
        
        html += `
            <div class="test-result-item">
                <div class="test-result-header">
                    <strong>Test Case ${index + 1}</strong>
                    <span class="${statusClass}">${statusText}</span>
                </div>
                <div class="card-body" style="color: #f0f6fc;">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Input:</strong>
                            <pre class="small mt-1" style="background: #0d1117; padding: 0.5rem; border-radius: 4px;">${result.input || 'N/A'}</pre>
                        </div>
                        <div class="col-md-4">
                            <strong>Expected:</strong>
                            <pre class="small mt-1" style="background: #0d1117; padding: 0.5rem; border-radius: 4px;">${result.expected || 'N/A'}</pre>
                        </div>
                        <div class="col-md-4">
                            <strong>Your Output:</strong>
                            <pre class="small mt-1" style="background: #0d1117; padding: 0.5rem; border-radius: 4px;">${result.output || result.error || 'No output'}</pre>
                        </div>
                    </div>
                    ${result.execution_time ? `<small class="text-muted">Execution time: ${result.execution_time}ms</small>` : ''}
                </div>
            </div>`;
    });
    
    // Add AI Analysis button if there are failures
    if (hasFailures) {
        html += `
            <div class="mt-3 p-3" style="background: #21262d; border-radius: 8px; border: 1px solid #30363d;">
                <h6><i class="fas fa-robot"></i> Need Help Debugging?</h6>
                <p class="text-muted mb-3">Let AI analyze your failed test cases and provide debugging suggestions.</p>
                <button type="button" class="btn btn-outline-warning" id="analyze-test-failures-btn">
                    <i class="fas fa-search"></i> Analyze Test Failures with AI
                </button>
                <div id="test-analysis-container" style="display: none;" class="mt-3">
                    <div class="alert alert-warning border-warning" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); border: 2px solid #ffc107; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);">
                        <h6 class="mb-3" style="color: #212529; font-weight: bold;">
                            <i class="fas fa-robot me-2"></i> AI Analysis
                        </h6>
                        <div id="test-analysis-content" style="color: #212529; font-size: 1.1rem; line-height: 1.6; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 8px; border-left: 4px solid #212529;"></div>
                    </div>
                </div>
            </div>`;
    }
    
    container.innerHTML = html;
    
    // Add event listener for AI analysis button
    if (hasFailures) {
        const analyzeBtn = document.getElementById('analyze-test-failures-btn');
        if (analyzeBtn) {
            analyzeBtn.addEventListener('click', function() {
                analyzeTestFailures(data);
            });
        }
    }
}

function analyzeTestFailures(testData) {
    const analyzeBtn = document.getElementById('analyze-test-failures-btn');
    const analysisContent = document.getElementById('test-analysis-content');
    const analysisContainer = document.getElementById('test-analysis-container');
    
    if (!analyzeBtn || !analysisContent || !analysisContainer) return;
    
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
    
    // Get current code and language
    const language = document.querySelector('#id_language').value;
    const sourceCode = editor ? editor.getValue() : document.querySelector('#id_source_code').value;
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        alert('CSRF token not found. Please refresh the page.');
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Analyze Test Failures with AI';
        return;
    }
    
    // Prepare failed test cases info
    const failedCases = testData.results.filter(result => !result.passed);
    const testCasesInfo = failedCases.map((result, index) => ({
        input: result.input,
        expected: result.expected,
        actual: result.output || result.error
    }));
    
    fetch('/ai/analyze-test-failures/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.value
        },
        body: JSON.stringify({
            problem_id: {{ problem.id }},
            language: language,
            source_code: sourceCode,
            failed_test_cases: testCasesInfo
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            analysisContent.innerHTML = data.analysis;
            analysisContainer.style.display = 'block';
            analysisContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Get Another Analysis';
        } else {
            alert('Error: ' + (data.error || 'Unable to analyze test failures'));
            analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Analyze Test Failures with AI';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error analyzing test failures: ' + error);
        analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Analyze Test Failures with AI';
    })
    .finally(() => {
        analyzeBtn.disabled = false;
    });
}

function displayCompilerResults(data) {
    const outputContainer = document.getElementById('compiler-output');
    const infoContainer = document.getElementById('compiler-info');
    
    if (data.success) {
        outputContainer.innerHTML = `<pre style="margin: 0; white-space: pre-wrap;">${data.output || 'No output'}</pre>`;
        infoContainer.innerHTML = `<i class="fas fa-check text-success"></i> Execution time: ${data.execution_time}ms`;
    } else {
        outputContainer.innerHTML = `<span class="text-danger">${data.error}</span>`;
        infoContainer.innerHTML = `<i class="fas fa-times text-danger"></i> ${data.compilation_error ? 'Compilation failed' : 'Runtime error'}`;
    }
}
</script>
{% endblock %}
