{% extends 'base.html' %}
{% load static %}

{% block title %}Submission #{{ submission.pk }} - Code Matrix{% endblock %}

{% block extra_css %}
<style>
.submission-header {
    background: var(--dark-secondary);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid var(--dark-border);
}

.verdict-badge {
    font-size: 1.1rem;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 600;
}

.verdict-AC { background: var(--success-color); color: white; }
.verdict-WA { background: var(--error-color); color: white; }
.verdict-TLE { background: var(--warning-color); color: var(--text-color); }
.verdict-MLE { background: var(--warning-color); color: var(--text-color); }
.verdict-RE { background: var(--error-color); color: white; }
.verdict-CE { background: var(--error-color); color: white; }
.verdict-PE { background: var(--primary-color); color: white; }

.code-section {
    background: var(--dark-secondary);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid var(--dark-border);
}

.code-block {
    background: var(--code-bg);
    border-radius: 6px;
    padding: 15px;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.4;
    border: 1px solid var(--dark-border);
    color: var(--text-color);
}

.test-results {
    background: var(--dark-secondary);
    border-radius: 8px;
    padding: 20px;
    border: 1px solid var(--dark-border);
}

.test-case {
    background: var(--dark-primary);
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid var(--dark-border);
}

.test-case-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.test-case-result {
    padding: 4px 12px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.9rem;
}

.result-PASS { background: var(--success-color); color: white; }
.result-FAIL { background: var(--error-color); color: white; }

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.stat-item {
    text-align: center;
    padding: 10px;
    background: var(--dark-primary);
    border-radius: 6px;
    border: 1px solid var(--dark-border);
}

.stat-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 5px;
}

.stat-value {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--accent-color);
}

.back-btn {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    text-decoration: none;
    display: inline-block;
    margin-bottom: 20px;
    transition: background 0.3s ease;
}

.back-btn:hover {
    background: var(--primary-hover);
    color: white;
    text-decoration: none;
}

.error-message {
    background: var(--error-bg);
    color: var(--error-color);
    padding: 15px;
    border-radius: 6px;
    margin-top: 15px;
    border: 1px solid var(--error-color);
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container">
    <a href="{% url 'submissions:list' %}" class="back-btn">
        <i class="fas fa-arrow-left"></i> Back to Submissions
    </a>

    <!-- Submission Header -->
    <div class="submission-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h3 class="mb-2">Submission #{{ submission.pk }}</h3>
                <p class="mb-2"><strong>Problem:</strong> 
                    <a href="{% url 'problems:detail' submission.problem.slug %}" class="text-info">
                        {{ submission.problem.title }}
                    </a>
                </p>
                <p class="mb-2"><strong>User:</strong> {{ submission.user.username }}</p>
                <p class="mb-0"><strong>Submitted:</strong> {{ submission.submitted_at|date:"M d, Y H:i" }}</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="verdict-badge verdict-{{ submission.verdict }}">
                    {{ submission.get_verdict_display }}
                </div>
                
                <div class="stats-grid mt-3">
                    {% if submission.execution_time %}
                    <div class="stat-item">
                        <div class="stat-label">Time</div>
                        <div class="stat-value">{{ submission.execution_time }}ms</div>
                    </div>
                    {% endif %}
                    
                    {% if submission.memory_used %}
                    <div class="stat-item">
                        <div class="stat-label">Memory</div>
                        <div class="stat-value">{{ submission.memory_used }}KB</div>
                    </div>
                    {% endif %}
                    
                    <div class="stat-item">
                        <div class="stat-label">Language</div>
                        <div class="stat-value">{{ submission.get_language_display }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Code Section -->
    <div class="code-section">
        <h4 class="mb-3"><i class="fas fa-code"></i> Source Code</h4>
        <div class="code-block">{{ submission.code }}</div>
    </div>

    <!-- Error Message (if any) -->
    {% if submission.error_message %}
    <div class="error-message">
        <h5><i class="fas fa-exclamation-triangle"></i> Error Message</h5>
        <pre>{{ submission.error_message }}</pre>
    </div>
    {% endif %}

    <!-- AI Analysis Section -->
    {% if user.is_authenticated and submission.user == user and submission.verdict in 'WA,RE,TLE' %}
    <div class="code-section">
        <h4 class="mb-3"><i class="fas fa-robot"></i> AI Analysis</h4>
        <p class="text-muted mb-3">
            Get AI-powered insights into why your submission failed and how to improve it.
        </p>
        <div class="d-grid gap-2 d-md-block">
            <button type="button" class="btn btn-outline-info" id="analyze-submission-btn">
                <i class="fas fa-search"></i> Analyze with AI
            </button>
        </div>
        <div id="ai-analysis-container" style="display: none;" class="mt-3">
            <div class="alert alert-info">
                <h6><i class="fas fa-robot"></i> AI Analysis:</h6>
                <div id="ai-analysis-content"></div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Test Results -->
    {% if test_results %}
    <div class="test-results">
        <h4 class="mb-3"><i class="fas fa-list-check"></i> Test Results</h4>
        
        {% for result in test_results %}
        <div class="test-case">
            <div class="test-case-header">
                <h5 class="mb-0">Test Case #{{ result.test_case_number }}</h5>
                <span class="test-case-result result-{{ result.result }}">
                    {{ result.get_result_display }}
                </span>
            </div>
            
            {% if result.execution_time or result.memory_used %}
            <div class="stats-grid">
                {% if result.execution_time %}
                <div class="stat-item">
                    <div class="stat-label">Time</div>
                    <div class="stat-value">{{ result.execution_time }}ms</div>
                </div>
                {% endif %}
                
                {% if result.memory_used %}
                <div class="stat-item">
                    <div class="stat-label">Memory</div>
                    <div class="stat-value">{{ result.memory_used }}KB</div>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            {% if result.error_message %}
            <div class="error-message">
                <strong>Error:</strong> {{ result.error_message }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="test-results">
        <h4 class="mb-3"><i class="fas fa-list-check"></i> Test Results</h4>
        <p class="text-muted">No test results available yet. The submission may still be processing.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // AI Analysis button
    const analyzeBtn = document.getElementById('analyze-submission-btn');
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', function() {
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            
            fetch(`/ai/analyze/{{ submission.id }}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('ai-analysis-content').innerHTML = data.analysis;
                    document.getElementById('ai-analysis-container').style.display = 'block';
                    analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Get Another Analysis';
                } else {
                    alert('Error: ' + (data.error || 'Unable to analyze submission'));
                    analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Analyze with AI';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error analyzing submission: ' + error);
                analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Analyze with AI';
            })
            .finally(() => {
                analyzeBtn.disabled = false;
            });
        });
    }
});

// Helper function to get CSRF token
function getCsrfToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '';
}
</script>

{% if submission.verdict == 'PE' %}
<script>
// Poll for submission status updates
function checkSubmissionStatus() {
    fetch('{% url "submissions:status" submission.pk %}')
        .then(response => response.json())
        .then(data => {
            if (data.verdict !== 'PE') {
                // Update the page with new status
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
}

// Check status every 2 seconds if still pending
if (document.querySelector('#status-info .spinner-border')) {
    const statusInterval = setInterval(() => {
        checkSubmissionStatus();
    }, 2000);
    
    // Stop polling after 2 minutes
    setTimeout(() => {
        clearInterval(statusInterval);
    }, 120000);
}
</script>
{% endif %}
{% endblock %}
